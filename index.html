<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTC智能预测系统 - 完整增强版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 保留原有完整CSS样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 2000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background: rgba(15, 32, 39, 0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            color: #f7931a;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-shadow: 0 0 10px rgba(247, 147, 26, 0.5);
        }
        
        .subtitle {
            color: #8a9ba8;
            font-size: 1.1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .subtitle-tag {
            background: rgba(247, 147, 26, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid rgba(247, 147, 26, 0.3);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 20px;
        }
        
        @media (max-width: 1400px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .chart-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel {
            background: rgba(15, 32, 39, 0.85);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            color: #f7931a;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            height: 500px;
            width: 100%;
            position: relative;
        }
        
        #chart {
            width: 100%;
            height: 100%;
        }
        
        /* 进场条件评估 */
        .entry-conditions {
            background: rgba(32, 58, 67, 0.6);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border-left: 5px solid #f7931a;
        }
        
        .condition-item {
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 5px;
            background: rgba(44, 83, 100, 0.4);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .condition-item.pass {
            color: #00c853;
            border-left: 3px solid #00c853;
        }
        
        .condition-item.fail {
            color: #ff3d00;
            border-left: 3px solid #ff3d00;
        }
        
        .condition-item.info {
            color: #8a9ba8;
            border-left: 3px solid #8a9ba8;
        }
        
        /* 深度图样式 */
        .depth-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .depth-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .depth-info {
            display: flex;
            gap: 20px;
        }
        
        .depth-chart-container {
            height: 300px;
            width: 100%;
            background: rgba(32, 58, 67, 0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        #depth-chart {
            width: 100%;
            height: 100%;
        }
        
        .depth-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .depth-stat {
            background: rgba(32, 58, 67, 0.6);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .depth-label {
            font-size: 0.85rem;
            color: #8a9ba8;
            margin-bottom: 5px;
        }
        
        .depth-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        /* 支撑压力位 */
        .support-resistance-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .sr-levels {
            background: rgba(32, 58, 67, 0.6);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .sr-title {
            color: #f7931a;
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sr-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .sr-price {
            font-weight: bold;
        }
        
        .sr-strength {
            color: #8a9ba8;
            font-size: 0.85rem;
        }
        
        .sr-support {
            color: #00c853;
        }
        
        .sr-resistance {
            color: #ff3d00;
        }
        
        /* MA线设置 */
        .ma-settings {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }
        
        .ma-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .ma-input {
            width: 60px;
            padding: 5px 8px;
            background: rgba(32, 58, 67, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            color: #e0e0e0;
            text-align: center;
        }
        
        .ma-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .ma-toggle input {
            cursor: pointer;
        }
        
        /* 预测结果 */
        .prediction-results {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .prediction-card {
            background: rgba(32, 58, 67, 0.6);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .prediction-type {
            font-size: 0.9rem;
            color: #8a9ba8;
            margin-bottom: 5px;
        }
        
        .prediction-value {
            font-size: 1.4rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .prediction-confidence {
            font-size: 0.85rem;
            color: #8a9ba8;
        }
        
        .up {
            color: #00c853;
        }
        
        .down {
            color: #ff3d00;
        }
        
        /* 控制面板 */
        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .stats-card {
            background: rgba(32, 58, 67, 0.6);
            border-radius: 10px;
            padding: 15px;
            border-left: 5px solid #f7931a;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.85rem;
            color: #8a9ba8;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .control-group {
            margin-top: 10px;
        }
        
        .control-group h4 {
            color: #8a9ba8;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: #f7931a;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #e08419;
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: #00c853;
        }
        
        .btn-success:hover {
            background: #00b248;
        }
        
        .btn-danger {
            background: #ff3d00;
        }
        
        .btn-danger:hover {
            background: #e03500;
        }
        
        .btn-info {
            background: #2196f3;
        }
        
        .btn-info:hover {
            background: #0d8bf2;
        }
        
        .btn-secondary {
            background: #2c5364;
        }
        
        .btn-secondary:hover {
            background: #203a43;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        /* 时间周期选择器 */
        .interval-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .interval-btn {
            flex: 1;
            min-width: 60px;
            padding: 8px 5px;
            background: rgba(44, 83, 100, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .interval-btn.active {
            background: #f7931a;
            color: white;
        }
        
        .interval-btn:hover:not(.active) {
            background: rgba(44, 83, 100, 0.8);
        }
        
        /* 语音控制 */
        .voice-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(32, 58, 67, 0.6);
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .voice-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }
        
        .status-indicator.connected {
            background: #00c853;
            box-shadow: 0 0 10px #00c853;
        }
        
        .status-indicator.disconnected {
            background: #ff3d00;
            box-shadow: 0 0 10px #ff3d00;
        }
        
        /* 模型状态 */
        .model-status {
            background: rgba(32, 58, 67, 0.6);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .model-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .model-progress {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .model-progress-bar {
            height: 100%;
            background: #f7931a;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        /* 分析结果 */
        .analysis-container {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .analysis-item {
            padding: 10px;
            background: rgba(32, 58, 67, 0.4);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            border-left: 3px solid #f7931a;
        }
        
        /* 价格显示 */
        .price-display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        
        .price-up {
            color: #00c853;
            text-shadow: 0 0 10px rgba(0, 200, 83, 0.5);
        }
        
        .price-down {
            color: #ff3d00;
            text-shadow: 0 0 10px rgba(255, 61, 0, 0.5);
        }
        
        .price-change {
            font-size: 1.2rem;
            margin-top: 5px;
            opacity: 0.8;
        }
        
        /* 倒计时 */
        .countdown-container {
            text-align: center;
            padding: 15px;
            background: rgba(32, 58, 67, 0.6);
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .countdown-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #f7931a;
            text-shadow: 0 0 10px rgba(247, 147, 26, 0.5);
        }
        
        .countdown-label {
            font-size: 0.9rem;
            color: #8a9ba8;
            margin-top: 5px;
        }
        
        /* 胜率统计详细面板 */
        .winrate-stats-detailed {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .winrate-stat {
            background: rgba(32, 58, 67, 0.6);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .winrate-label {
            font-size: 0.85rem;
            color: #8a9ba8;
            margin-bottom: 5px;
        }
        
        .winrate-value {
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        /* 技术指标信号 */
        .technical-signals {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .signal-card {
            background: rgba(32, 58, 67, 0.6);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .signal-title {
            font-size: 0.9rem;
            color: #8a9ba8;
            margin-bottom: 5px;
        }
        
        .signal-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .signal-bullish {
            color: #00c853;
            border-color: rgba(0, 200, 83, 0.3);
        }
        
        .signal-bearish {
            color: #ff3d00;
            border-color: rgba(255, 61, 0, 0.3);
        }
        
        .signal-neutral {
            color: #8a9ba8;
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        /* 进场条件评分 */
        .entry-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding: 10px;
            background: rgba(32, 58, 67, 0.6);
            border-radius: 10px;
        }
        
        .score-bar {
            flex-grow: 1;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 0 15px;
        }
        
        .score-fill {
            height: 100%;
            background: #f7931a;
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .score-text {
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* 日志输出 */
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #8a9ba8;
        }
        
        .log-time {
            color: #f7931a;
            margin-right: 10px;
        }
        
        /* 自动预测状态 */
        .auto-prediction-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: rgba(32, 58, 67, 0.6);
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .auto-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            margin-right: 8px;
        }
        
        .auto-status-dot.active {
            background: #00c853;
            box-shadow: 0 0 8px #00c853;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* 响应式调整 */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .prediction-results {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .price-display {
                font-size: 2rem;
            }
            
            .support-resistance-container {
                grid-template-columns: 1fr;
            }
            
            .depth-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .technical-signals {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .winrate-stats-detailed {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container {
                height: 400px;
            }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #8a9ba8;
            font-size: 0.9rem;
            margin-top: 20px;
            background: rgba(15, 32, 39, 0.8);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #f7931a;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-brain"></i> BTC智能预测系统 - 完整增强版</h1>
            <div class="subtitle">
                <span><i class="fas fa-chart-line"></i> 5分钟预测系统</span>
                <span><i class="fas fa-trophy"></i> 胜率统计</span>
                <span><i class="fas fa-filter"></i> 进场条件评估</span>
                <span><i class="fas fa-robot"></i> 自动预测</span>
                <span class="subtitle-tag">技术信号 + 机器学习 + 完整风控</span>
            </div>
        </header>
        
        <div class="main-content">
            <!-- 左侧：图表和技术分析 -->
            <div class="chart-section">
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-chart-candlestick"></i> BTC/USDT K线图表 + MA线
                        </div>
                        <div class="ma-settings">
                            <span style="color: #8a9ba8; font-size: 0.9rem;">MA周期:</span>
                            <div class="ma-input-group">
                                <label>MA5</label>
                                <input type="checkbox" id="ma5-toggle" checked>
                            </div>
                            <div class="ma-input-group">
                                <label>MA10</label>
                                <input type="checkbox" id="ma10-toggle" checked>
                            </div>
                            <div class="ma-input-group">
                                <label>MA20</label>
                                <input type="checkbox" id="ma20-toggle" checked>
                            </div>
                            <div class="ma-input-group">
                                <label>MA60</label>
                                <input type="checkbox" id="ma60-toggle">
                            </div>
                        </div>
                        <div class="interval-selector">
                            <button class="interval-btn active" data-interval="1m">1分钟</button>
                            <button class="interval-btn" data-interval="5m">5分钟</button>
                            <button class="interval-btn" data-interval="15m">15分钟</button>
                            <button class="interval-btn" data-interval="1h">1小时</button>
                            <button class="interval-btn" data-interval="4h">4小时</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div id="chart"></div>
                    </div>
                </div>
                
                <!-- 进场条件评估 -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-filter"></i> 进场条件评估
                        </div>
                        <button class="btn btn-small btn-secondary" id="evaluate-entry-btn">
                            <i class="fas fa-sync-alt"></i> 重新评估
                        </button>
                    </div>
                    
                    <!-- 自动预测状态显示 -->
                    <div class="auto-prediction-status">
                        <div style="display: flex; align-items: center;">
                            <div class="auto-status-dot" id="auto-status-dot"></div>
                            <span id="auto-status-text">自动评估: 关闭</span>
                        </div>
                        <span id="auto-next-time" style="color: #8a9ba8; font-size: 0.8rem;">--</span>
                    </div>
                    
                    <div class="entry-score">
                        <span>进场条件评分</span>
                        <div class="score-bar">
                            <div class="score-fill" id="score-fill"></div>
                        </div>
                        <span class="score-text" id="score-text">0%</span>
                    </div>
                    
                    <div class="entry-conditions" id="entry-conditions">
                        <div class="condition-item info">
                            <i class="fas fa-info-circle"></i> 点击"重新评估"按钮开始分析...
                        </div>
                    </div>
                    
                    <!-- 技术指标信号 -->
                    <div class="technical-signals">
                        <div class="signal-card signal-neutral" id="orderbook-signal">
                            <div class="signal-title">订单簿信号</div>
                            <div class="signal-value">--</div>
                        </div>
                        <div class="signal-card signal-neutral" id="technical-signal">
                            <div class="signal-title">技术指标</div>
                            <div class="signal-value">--</div>
                        </div>
                        <div class="signal-card signal-neutral" id="ma-cross-signal">
                            <div class="signal-title">MA交叉</div>
                            <div class="signal-value">--</div>
                        </div>
                        <div class="signal-card signal-neutral" id="support-resistance-signal">
                            <div class="signal-title">支撑压力</div>
                            <div class="signal-value">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- 深度图面板 -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-chart-area"></i> BTC/USDT 深度图（委托订单）
                        </div>
                        <div class="depth-info">
                            <div style="color: #00c853; font-weight: bold;" id="depth-best-bid">买: --</div>
                            <div style="color: #ff3d00; font-weight: bold;" id="depth-best-ask">卖: --</div>
                            <div style="color: #8a9ba8;" id="depth-spread">价差: --</div>
                        </div>
                    </div>
                    <div class="depth-container">
                        <div class="depth-chart-container">
                            <canvas id="depth-chart"></canvas>
                        </div>
                        <div class="depth-stats">
                            <div class="depth-stat">
                                <div class="depth-label">买盘总量</div>
                                <div class="depth-value" id="total-bid">--</div>
                            </div>
                            <div class="depth-stat">
                                <div class="depth-label">卖盘总量</div>
                                <div class="depth-value" id="total-ask">--</div>
                            </div>
                            <div class="depth-stat">
                                <div class="depth-label">买卖比例</div>
                                <div class="depth-value" id="bid-ask-ratio">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：控制面板和预测结果 -->
            <div class="control-panel">
                <!-- 价格和预测显示 -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-dollar-sign"></i> 当前价格 & 5分钟预测
                        </div>
                        <div class="status-indicator" id="price-status"></div>
                    </div>
                    <div class="price-display" id="current-price">
                        $--
                    </div>
                    
                    <div class="prediction-results">
                        <div class="prediction-card">
                            <div class="prediction-type">预测方向</div>
                            <div class="prediction-value" id="prediction-direction">--</div>
                            <div class="prediction-confidence" id="prediction-confidence">置信度: --</div>
                        </div>
                        
                        <div class="prediction-card">
                            <div class="prediction-type">开始价格</div>
                            <div class="prediction-value" id="start-price">$--</div>
                            <div class="prediction-confidence">预测开始时</div>
                        </div>
                        
                        <div class="prediction-card">
                            <div class="prediction-type">当前结果</div>
                            <div class="prediction-value" id="current-result">--</div>
                            <div class="prediction-confidence" id="result-change">变化: --</div>
                        </div>
                    </div>
                    
                    <div class="countdown-container">
                        <div class="countdown-value" id="countdown">05:00</div>
                        <div class="countdown-label">5分钟预测倒计时</div>
                    </div>
                </div>
                
                <!-- 胜率统计详细面板 -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-trophy"></i> 胜率统计详情
                        </div>
                        <button class="btn btn-small btn-secondary" id="reset-stats-btn">
                            <i class="fas fa-redo"></i> 重置
                        </button>
                    </div>
                    
                    <div class="winrate-stats-detailed">
                        <div class="winrate-stat">
                            <div class="winrate-label">总交易次数</div>
                            <div class="winrate-value" id="total-trades">0</div>
                        </div>
                        <div class="winrate-stat">
                            <div class="winrate-label">盈利交易</div>
                            <div class="winrate-value" id="winning-trades">0</div>
                        </div>
                        <div class="winrate-stat">
                            <div class="winrate-label">亏损交易</div>
                            <div class="winrate-value" id="losing-trades">0</div>
                        </div>
                        <div class="winrate-stat">
                            <div class="winrate-label">总胜率</div>
                            <div class="winrate-value" id="total-win-rate">0%</div>
                        </div>
                        <div class="winrate-stat">
                            <div class="winrate-label">近期胜率</div>
                            <div class="winrate-value" id="recent-win-rate">0%</div>
                        </div>
                        <div class="winrate-stat">
                            <div class="winrate-label">当前连胜</div>
                            <div class="winrate-value" id="current-streak">0</div>
                        </div>
                    </div>
                    
                    <div class="stats-grid" style="margin-top: 15px;">
                        <div class="stat-item">
                            <div class="stat-label">最大连胜</div>
                            <div class="stat-value" id="best-streak">0</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-label">最大连败</div>
                            <div class="stat-value" id="worst-streak">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- 系统控制 -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-cogs"></i> 系统控制
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-success" id="connect-btn">
                            <i class="fas fa-plug"></i> 连接数据
                        </button>
                        <button class="btn btn-danger" id="disconnect-btn" disabled>
                            <i class="fas fa-power-off"></i> 断开连接
                        </button>
                        <button class="btn btn-info" id="start-prediction-btn">
                            <i class="fas fa-play"></i> 开始预测
                        </button>
                        <button class="btn btn-secondary" id="stop-prediction-btn" disabled>
                            <i class="fas fa-stop"></i> 停止预测
                        </button>
                    </div>
                    
                    <div class="control-group">
                        <h4><i class="fas fa-sliders-h"></i> 预测模式设置</h4>
                        <div style="background: rgba(32, 58, 67, 0.6); border-radius: 10px; padding: 10px; margin-top: 5px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 0.9rem;">自动评估进场条件</span>
                                <label class="switch">
                                    <input type="checkbox" id="auto-evaluate-toggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 0.9rem;">自动预测模式</span>
                                <label class="switch">
                                    <input type="checkbox" id="auto-predict-toggle" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div style="font-size: 0.8rem; color: #8a9ba8;">
                                开启后每30秒自动评估，评分≥60%且出现技术信号时自动预测
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-group">
                        <h4><i class="fas fa-microphone"></i> 语音控制</h4>
                        <div class="voice-control">
                            <div class="voice-status">
                                <div class="status-indicator" id="voice-indicator"></div>
                                <span id="voice-status-text">语音关闭</span>
                            </div>
                            <button class="btn btn-small btn-secondary" id="toggle-voice-btn">
                                <i class="fas fa-volume-mute"></i> 开启语音
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 分析日志 -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-title">
                            <i class="fas fa-chart-bar"></i> 实时分析日志
                        </div>
                        <button class="btn btn-small btn-secondary" id="clear-log-btn">
                            <i class="fas fa-trash"></i> 清空
                        </button>
                    </div>
                    
                    <div class="log-container" id="log-container">
                        <div class="log-entry">
                            <span class="log-time">[系统]</span> BTC智能预测系统已启动
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>系统说明：本系统以5分钟预测周期为核心，结合技术指标分析、订单簿深度分析、进场条件评估和胜率统计，为BTC/USDT交易提供决策支持。</p>
            <p>© 2023 BTC智能预测系统 | 数据来源：币安交易所 | 算法：技术分析 + 风险控制 + 胜率统计</p>
        </footer>
    </div>

<script>
// ========== 全局变量 ==========
let chart = null;
let candleSeries = null;
let ma5Series = null;
let ma10Series = null;
let ma20Series = null;
let ma60Series = null;
let ws = null;
let orderbookWs = null;
let currentInterval = '1m';
let voiceEnabled = false;
let speechSynthesis = window.speechSynthesis;
let isConnected = false;
let isPredicting = false;
let countdownInterval = null;
let countdownSeconds = 300; // 5分钟
let currentPrice = 0;
let startPrice = 0;
let predictionStartTime = null;
let currentPrediction = null;
let autoEvaluationInterval = null; // 自动评估间隔
let lastAutoPredictionTime = 0; // 上次自动预测时间
let autoPredictionCooldown = 300000; // 自动预测冷却时间5分钟

// 胜率统计系统
class WinRateTracker {
    constructor() {
        this.history = []; // 最多保存100条记录
        this.consecutiveWins = 0;
        this.consecutiveLosses = 0;
        this.totalTrades = 0;
        this.winningTrades = 0;
        this.maxHistorySize = 100;
    }

    addTrade(isWin) {
        this.history.push(isWin);
        if (this.history.length > this.maxHistorySize) {
            this.history.shift();
        }
        
        this.totalTrades++;
        
        if (isWin) {
            this.winningTrades++;
            this.consecutiveWins++;
            this.consecutiveLosses = 0;
        } else {
            this.consecutiveWins = 0;
            this.consecutiveLosses++;
        }
        
        this.save();
        this.updateDisplay();
    }

    getStatistics() {
        const totalWinRate = this.totalTrades > 0 ? 
            this.winningTrades / this.totalTrades : 0;
        
        // 近期胜率 (最近20次)
        const recent = this.history.slice(-20);
        const recentWinRate = recent.length > 0 ? 
            recent.filter(h => h).length / recent.length : 0;
        
        // 计算最大连胜/连败
        let bestStreak = 0;
        let worstStreak = 0;
        let currentStreak = 0;
        let currentType = null;
        
        for (const result of this.history) {
            if (currentType === null) {
                currentType = result;
                currentStreak = 1;
            } else if (result === currentType) {
                currentStreak++;
            } else {
                if (currentType) {
                    bestStreak = Math.max(bestStreak, currentStreak);
                } else {
                    worstStreak = Math.max(worstStreak, currentStreak);
                }
                currentType = result;
                currentStreak = 1;
            }
        }
        
        if (currentType) {
            bestStreak = Math.max(bestStreak, currentStreak);
        } else {
            worstStreak = Math.max(worstStreak, currentStreak);
        }
        
        return {
            totalWinRate,
            recentWinRate,
            totalTrades: this.totalTrades,
            winningTrades: this.winningTrades,
            losingTrades: this.totalTrades - this.winningTrades,
            consecutiveWins: this.consecutiveWins,
            consecutiveLosses: this.consecutiveLosses,
            bestStreak,
            worstStreak
        };
    }

    updateDisplay() {
        const stats = this.getStatistics();
        
        document.getElementById('total-trades').textContent = stats.totalTrades;
        document.getElementById('winning-trades').textContent = stats.winningTrades;
        document.getElementById('losing-trades').textContent = stats.losingTrades;
        document.getElementById('total-win-rate').textContent = `${(stats.totalWinRate * 100).toFixed(1)}%`;
        document.getElementById('recent-win-rate').textContent = `${(stats.recentWinRate * 100).toFixed(1)}%`;
        document.getElementById('current-streak').textContent = stats.consecutiveWins > 0 ? 
            `${stats.consecutiveWins}连胜` : `${stats.consecutiveLosses}连败`;
        document.getElementById('best-streak').textContent = stats.bestStreak;
        document.getElementById('worst-streak').textContent = stats.worstStreak;
    }

    save() {
        const stats = {
            history: this.history,
            consecutiveWins: this.consecutiveWins,
            consecutiveLosses: this.consecutiveLosses,
            totalTrades: this.totalTrades,
            winningTrades: this.winningTrades,
            savedAt: new Date().toISOString()
        };
        
        try {
            localStorage.setItem('btc_winrate_stats', JSON.stringify(stats));
            log('胜率统计已保存');
        } catch (error) {
            log(`保存胜率统计失败: ${error}`, 'error');
        }
    }

    load() {
        try {
            const saved = localStorage.getItem('btc_winrate_stats');
            if (saved) {
                const stats = JSON.parse(saved);
                this.history = stats.history || [];
                this.consecutiveWins = stats.consecutiveWins || 0;
                this.consecutiveLosses = stats.consecutiveLosses || 0;
                this.totalTrades = stats.totalTrades || 0;
                this.winningTrades = stats.winningTrades || 0;
                
                const savedAt = stats.savedAt ? new Date(stats.savedAt).toLocaleString() : '未知时间';
                log(`胜率统计已加载 (保存于: ${savedAt})`);
                this.updateDisplay();
                return true;
            }
        } catch (error) {
            log(`加载胜率统计失败: ${error}`, 'error');
        }
        return false;
    }

    reset() {
        this.history = [];
        this.consecutiveWins = 0;
        this.consecutiveLosses = 0;
        this.totalTrades = 0;
        this.winningTrades = 0;
        this.save();
        this.updateDisplay();
        log('胜率统计已重置');
    }
}

// 实例化胜率统计
const winRateTracker = new WinRateTracker();

// 委托订单数据
let depthData = {
    bids: [],
    asks: []
};

// K线数据
let klineData = [];
const MAX_DATA_POINTS = 200;

// 技术指标数据
let technicalIndicators = {
    ma5: [],
    ma10: [],
    ma20: [],
    ma60: [],
    rsi: null,
    macd: null,
    bollinger: null,
    atr: null
};

// 进场条件评估
let entryConditions = {
    score: 0,
    shouldEnter: false,
    conditions: []
};

// 技术信号状态
let technicalSignals = {
    maCross: null, // 'golden-cross', 'death-cross', null
    supportResistance: null, // 'strong-support', 'strong-resistance', null
    rsiSignal: null, // 'oversold', 'overbought', null
    volumeSignal: null // 'high-volume', 'low-volume', null
};

// 深度图图表
let depthChart = null;

// ========== 初始化函数 ==========
function initChart() {
    const chartContainer = document.getElementById('chart');
    chartContainer.innerHTML = '';
    
    chart = LightweightCharts.createChart(chartContainer, {
        width: chartContainer.clientWidth,
        height: 500,
        layout: {
            backgroundColor: '#0f2027',
            textColor: '#8a9ba8',
        },
        grid: {
            vertLines: { color: 'rgba(138, 155, 168, 0.1)' },
            horzLines: { color: 'rgba(138, 155, 168, 0.1)' },
        },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { 
            borderColor: 'rgba(138, 155, 168, 0.2)',
            scaleMargins: {
                top: 0.2,
                bottom: 0.2,
            },
        },
        timeScale: {
            borderColor: 'rgba(138, 155, 168, 0.2)',
            timeVisible: true,
            secondsVisible: false,
        },
    });
    
    candleSeries = chart.addCandlestickSeries({
        upColor: '#00c853',
        downColor: '#ff3d00',
        borderDownColor: '#ff3d00',
        borderUpColor: '#00c853',
        wickDownColor: '#ff3d00',
        wickUpColor: '#00c853',
    });
    
    ma5Series = chart.addLineSeries({
        color: '#2196F3',
        lineWidth: 2,
        title: 'MA5',
        lineStyle: 0,
        priceScaleId: 'right',
    });
    
    ma10Series = chart.addLineSeries({
        color: '#FF9800',
        lineWidth: 2,
        title: 'MA10',
        lineStyle: 0,
        priceScaleId: 'right',
    });
    
    ma20Series = chart.addLineSeries({
        color: '#9C27B0',
        lineWidth: 2,
        title: 'MA20',
        lineStyle: 0,
        priceScaleId: 'right',
    });
    
    ma60Series = chart.addLineSeries({
        color: '#795548',
        lineWidth: 2,
        title: 'MA60',
        lineStyle: 0,
        priceScaleId: 'right',
    });
    
    window.addEventListener('resize', () => {
        if (chart) {
            chart.applyOptions({ width: chartContainer.clientWidth });
        }
    });
    
    log('图表初始化完成');
}

function initDepthChart() {
    const ctx = document.getElementById('depth-chart').getContext('2d');
    
    if (depthChart) {
        depthChart.destroy();
    }
    
    depthChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: '买盘深度',
                    data: [],
                    borderColor: '#00c853',
                    backgroundColor: 'rgba(0, 200, 83, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: '卖盘深度',
                    data: [],
                    borderColor: '#ff3d00',
                    backgroundColor: 'rgba(255, 61, 0, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#8a9ba8'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    ticks: {
                        color: '#8a9ba8'
                    },
                    grid: {
                        color: 'rgba(138, 155, 168, 0.1)'
                    }
                },
                y: {
                    ticks: {
                        color: '#8a9ba8'
                    },
                    grid: {
                        color: 'rgba(138, 155, 168, 0.1)'
                    }
                }
            }
        }
    });
    
    log('深度图初始化完成');
}

function initEventListeners() {
    document.getElementById('connect-btn').addEventListener('click', connectWebSocket);
    document.getElementById('disconnect-btn').addEventListener('click', disconnectWebSocket);
    
    document.getElementById('start-prediction-btn').addEventListener('click', startPrediction);
    document.getElementById('stop-prediction-btn').addEventListener('click', stopPrediction);
    
    document.getElementById('toggle-voice-btn').addEventListener('click', toggleVoice);
    
    document.getElementById('reset-stats-btn').addEventListener('click', () => {
        if (confirm('确定要重置所有胜率统计吗？此操作不可撤销。')) {
            winRateTracker.reset();
            speak('胜率统计已重置');
        }
    });
    
    document.getElementById('clear-log-btn').addEventListener('click', () => {
        document.getElementById('log-container').innerHTML = '';
        log('日志已清空');
    });
    
    document.getElementById('evaluate-entry-btn').addEventListener('click', evaluateEntryConditions);
    
    document.querySelectorAll('.interval-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            changeInterval(this.dataset.interval);
        });
    });
    
    document.getElementById('ma5-toggle').addEventListener('change', updateMALines);
    document.getElementById('ma10-toggle').addEventListener('change', updateMALines);
    document.getElementById('ma20-toggle').addEventListener('change', updateMALines);
    document.getElementById('ma60-toggle').addEventListener('change', updateMALines);
    
    // 自动预测切换
    document.getElementById('auto-predict-toggle').addEventListener('change', toggleAutoPrediction);
}

function initSystem() {
    log('系统初始化中...');
    
    initChart();
    initDepthChart();
    initEventListeners();
    
    // 加载胜率统计
    winRateTracker.load();
    
    updateStatus('就绪');
    updateVoiceStatus();
    updateAutoPredictionStatus();
    
    log('系统初始化完成');
    
    // 自动连接数据
    setTimeout(() => {
        connectWebSocket();
    }, 1000);
}

// ========== 数据连接 ==========
function connectWebSocket() {
    if (isConnected) {
        alert('已经连接到数据源');
        return;
    }
    
    if (ws) ws.close();
    
    try {
        const wsEndpoint = `wss://stream.binance.com:443/ws/btcusdt@kline_${currentInterval}`;
        ws = new WebSocket(wsEndpoint);
        
        ws.onopen = () => {
            log('已连接到币安WebSocket');
            isConnected = true;
            updateConnectionStatus(true);
            
            fetchHistoricalData();
            connectDepthWebSocket();
            startPriceUpdates();
            startAutoEvaluation(); // 开始自动评估
            
            speak('数据连接成功');
        };
        
        ws.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data && data.k) {
                    processKlineData(data.k);
                }
            } catch (error) {
                log(`解析WebSocket数据失败: ${error}`, 'error');
            }
        };
        
        ws.onerror = (error) => {
            log(`WebSocket错误: ${error}`, 'error');
            updateConnectionStatus(false);
            
            log('WebSocket连接失败，尝试HTTP轮询...');
            startHttpPolling();
        };
        
        ws.onclose = () => {
            log('WebSocket连接已关闭');
            isConnected = false;
            updateConnectionStatus(false);
            stopAutoEvaluation();
        };
        
    } catch (error) {
        log(`创建WebSocket连接失败: ${error}`, 'error');
        startHttpPolling();
    }
}

function connectDepthWebSocket() {
    try {
        const wsEndpoint = 'wss://stream.binance.com:443/ws/btcusdt@depth20@100ms';
        orderbookWs = new WebSocket(wsEndpoint);
        
        orderbookWs.onopen = () => {
            log('深度数据WebSocket已连接');
        };
        
        orderbookWs.onmessage = (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data && (data.bids || data.asks)) {
                    processDepthData(data);
                }
            } catch (error) {
                log(`解析深度数据失败: ${error}`, 'error');
            }
        };
        
        orderbookWs.onerror = (error) => {
            log(`深度数据WebSocket错误: ${error}`, 'error');
        };
        
    } catch (error) {
        log(`创建深度数据WebSocket连接失败: ${error}`, 'error');
    }
}

function startHttpPolling() {
    log('开始HTTP轮询获取数据');
    isConnected = true;
    updateConnectionStatus(true);
    
    fetchHistoricalData();
    
    setInterval(() => {
        fetchLatestData();
    }, 5000);
    
    setInterval(() => {
        fetchDepthData();
    }, 3000);
    
    startPriceUpdates();
    startAutoEvaluation();
}

function startPriceUpdates() {
    setInterval(() => {
        fetchCurrentPrice();
    }, 3000);
}

function disconnectWebSocket() {
    if (ws) {
        ws.close();
        ws = null;
    }
    
    if (orderbookWs) {
        orderbookWs.close();
        orderbookWs = null;
    }
    
    isConnected = false;
    updateConnectionStatus(false);
    stopAutoEvaluation();
    log('已断开数据连接');
    
    // 如果正在预测，停止预测
    if (isPredicting) {
        stopPrediction();
    }
    
    speak('数据连接已断开');
}

// ========== 数据获取 ==========
async function fetchHistoricalData() {
    try {
        const apiUrl = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${currentInterval}&limit=200`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP错误: ${response.status}`);
        }
        
        const klines = await response.json();
        klineData = [];
        
        klines.forEach(k => {
            const dataPoint = {
                time: Math.floor(k[0] / 1000),
                open: parseFloat(k[1]),
                high: parseFloat(k[2]),
                low: parseFloat(k[3]),
                close: parseFloat(k[4]),
                volume: parseFloat(k[5]),
            };
            
            klineData.push(dataPoint);
        });
        
        log(`获取到 ${klineData.length} 条历史数据`);
        updateChart();
        calculateMAs();
        calculateSupportResistance();
        
        if (klineData.length > 0) {
            currentPrice = klineData[klineData.length - 1].close;
            updatePriceDisplay(currentPrice);
        }
        
    } catch (error) {
        log(`获取历史数据失败: ${error}`, 'error');
        generateDemoData();
    }
}

async function fetchLatestData() {
    try {
        const apiUrl = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=${currentInterval}&limit=5`;
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP错误: ${response.status}`);
        }
        
        const klines = await response.json();
        
        if (klines.length > 0) {
            const k = klines[klines.length - 1];
            const newDataPoint = {
                time: Math.floor(k[0] / 1000),
                open: parseFloat(k[1]),
                high: parseFloat(k[2]),
                low: parseFloat(k[3]),
                close: parseFloat(k[4]),
                volume: parseFloat(k[5]),
            };
            
            if (klineData.length === 0 || newDataPoint.time > klineData[klineData.length - 1].time) {
                klineData.push(newDataPoint);
                if (klineData.length > MAX_DATA_POINTS) {
                    klineData.shift();
                }
            } else {
                klineData[klineData.length - 1] = newDataPoint;
            }
            
            updateChart();
            calculateMAs();
            calculateSupportResistance();
            currentPrice = newDataPoint.close;
            updatePriceDisplay(currentPrice);
        }
        
    } catch (error) {
        log(`获取最新数据失败: ${error}`, 'error');
    }
}

async function fetchDepthData() {
    try {
        const apiUrl = 'https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=100';
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP错误: ${response.status}`);
        }
        
        const data = await response.json();
        processDepthData(data);
        
    } catch (error) {
        log(`获取深度数据失败: ${error}`, 'error');
        generateDemoDepthData();
    }
}

async function fetchCurrentPrice() {
    try {
        const apiUrl = 'https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT';
        const response = await fetch(apiUrl);
        
        if (!response.ok) {
            throw new Error(`HTTP错误: ${response.status}`);
        }
        
        const data = await response.json();
        currentPrice = parseFloat(data.price);
        updatePriceDisplay(currentPrice);
        
        // 如果正在预测，更新当前结果
        if (isPredicting && startPrice > 0) {
            updateCurrentResult();
        }
        
    } catch (error) {
        log(`获取当前价格失败: ${error}`, 'error');
    }
}

// ========== 数据处理 ==========
function processKlineData(kline) {
    const newDataPoint = {
        time: Math.floor(kline.t / 1000),
        open: parseFloat(kline.o),
        high: parseFloat(kline.h),
        low: parseFloat(kline.l),
        close: parseFloat(kline.c),
        volume: parseFloat(kline.v),
        isClosed: kline.x,
    };
    
    currentPrice = newDataPoint.close;
    updatePriceDisplay(currentPrice);
    
    if (newDataPoint.isClosed) {
        klineData.push(newDataPoint);
        if (klineData.length > MAX_DATA_POINTS) {
            klineData.shift();
        }
        
        updateChart();
        calculateMAs();
        calculateSupportResistance();
        
    } else {
        if (klineData.length > 0) {
            klineData[klineData.length - 1] = newDataPoint;
            updateChart();
            calculateMAs();
            calculateSupportResistance();
        }
    }
}

function processDepthData(data) {
    if (data.bids && data.bids.length > 0) {
        depthData.bids = data.bids.map(bid => ({
            price: parseFloat(bid[0]),
            quantity: parseFloat(bid[1])
        })).sort((a, b) => b.price - a.price);
    }
    
    if (data.asks && data.asks.length > 0) {
        depthData.asks = data.asks.map(ask => ({
            price: parseFloat(ask[0]),
            quantity: parseFloat(ask[1])
        })).sort((a, b) => a.price - b.price);
    }
    
    updateDepthDisplay();
}

// ========== 技术指标计算 ==========
function calculateMAs() {
    if (klineData.length < 60) return;
    
    technicalIndicators.ma5 = [];
    technicalIndicators.ma10 = [];
    technicalIndicators.ma20 = [];
    technicalIndicators.ma60 = [];
    
    // 计算MA5
    for (let i = 4; i < klineData.length; i++) {
        let sum = 0;
        for (let j = 0; j < 5; j++) {
            sum += klineData[i - j].close;
        }
        technicalIndicators.ma5.push({
            time: klineData[i].time,
            value: sum / 5
        });
    }
    
    // 计算MA10
    for (let i = 9; i < klineData.length; i++) {
        let sum = 0;
        for (let j = 0; j < 10; j++) {
            sum += klineData[i - j].close;
        }
        technicalIndicators.ma10.push({
            time: klineData[i].time,
            value: sum / 10
        });
    }
    
    // 计算MA20
    for (let i = 19; i < klineData.length; i++) {
        let sum = 0;
        for (let j = 0; j < 20; j++) {
            sum += klineData[i - j].close;
        }
        technicalIndicators.ma20.push({
            time: klineData[i].time,
            value: sum / 20
        });
    }
    
    // 计算MA60
    for (let i = 59; i < klineData.length; i++) {
        let sum = 0;
        for (let j = 0; j < 60; j++) {
            sum += klineData[i - j].close;
        }
        technicalIndicators.ma60.push({
            time: klineData[i].time,
            value: sum / 60
        });
    }
    
    updateMALines();
    detectMACross();
}

// 计算支撑位和压力位
function calculateSupportResistance() {
    if (klineData.length < 20) return;
    
    // 寻找最近的高点和低点
    let recentHighs = [];
    let recentLows = [];
    
    // 分析最近50根K线
    const lookback = Math.min(50, klineData.length);
    const recentData = klineData.slice(-lookback);
    
    // 寻找局部高点和低点
    for (let i = 2; i < recentData.length - 2; i++) {
        if (recentData[i].high > recentData[i-1].high && 
            recentData[i].high > recentData[i-2].high &&
            recentData[i].high > recentData[i+1].high && 
            recentData[i].high > recentData[i+2].high) {
            recentHighs.push({
                price: recentData[i].high,
                time: recentData[i].time
            });
        }
        
        if (recentData[i].low < recentData[i-1].low && 
            recentData[i].low < recentData[i-2].low &&
            recentData[i].low < recentData[i+1].low && 
            recentData[i].low < recentData[i+2].low) {
            recentLows.push({
                price: recentData[i].low,
                time: recentData[i].time
            });
        }
    }
    
    // 获取当前价格
    const currentPrice = klineData[klineData.length - 1].close;
    
    // 分析支撑压力信号
    let supportResistanceSignal = null;
    let supportResistanceText = '中性';
    
    // 检查是否接近支撑位
    if (recentLows.length > 0) {
        const closestSupport = recentLows.reduce((prev, curr) => {
            return (Math.abs(curr.price - currentPrice) < Math.abs(prev.price - currentPrice)) ? curr : prev;
        });
        
        const supportDistance = ((currentPrice - closestSupport.price) / currentPrice * 100);
        
        if (supportDistance < 1 && supportDistance > 0) {
            supportResistanceSignal = 'strong-support';
            supportResistanceText = '强支撑';
        } else if (supportDistance < 2 && supportDistance > 0) {
            supportResistanceSignal = 'support';
            supportResistanceText = '接近支撑';
        }
    }
    
    // 检查是否接近压力位
    if (recentHighs.length > 0) {
        const closestResistance = recentHighs.reduce((prev, curr) => {
            return (Math.abs(curr.price - currentPrice) < Math.abs(prev.price - currentPrice)) ? curr : prev;
        });
        
        const resistanceDistance = ((closestResistance.price - currentPrice) / currentPrice * 100);
        
        if (resistanceDistance < 1 && resistanceDistance > 0) {
            supportResistanceSignal = 'strong-resistance';
            supportResistanceText = '强压力';
        } else if (resistanceDistance < 2 && resistanceDistance > 0) {
            supportResistanceSignal = 'resistance';
            supportResistanceText = '接近压力';
        }
    }
    
    technicalSignals.supportResistance = supportResistanceSignal;
    
    // 更新支撑压力信号显示
    const supportResistanceElement = document.getElementById('support-resistance-signal');
    supportResistanceElement.querySelector('.signal-value').textContent = supportResistanceText;
    
    if (supportResistanceSignal === 'strong-support') {
        supportResistanceElement.className = 'signal-card signal-bullish';
    } else if (supportResistanceSignal === 'strong-resistance') {
        supportResistanceElement.className = 'signal-card signal-bearish';
    } else if (supportResistanceSignal === 'support') {
        supportResistanceElement.className = 'signal-card signal-bullish';
    } else if (supportResistanceSignal === 'resistance') {
        supportResistanceElement.className = 'signal-card signal-bearish';
    } else {
        supportResistanceElement.className = 'signal-card signal-neutral';
    }
    
    return { recentHighs, recentLows };
}

// 检测MA金叉死叉
function detectMACross() {
    if (technicalIndicators.ma5.length < 2 || technicalIndicators.ma10.length < 2) return;
    
    const ma5Latest = technicalIndicators.ma5[technicalIndicators.ma5.length - 1];
    const ma5Previous = technicalIndicators.ma5[technicalIndicators.ma5.length - 2];
    const ma10Latest = technicalIndicators.ma10[technicalIndicators.ma10.length - 1];
    const ma10Previous = technicalIndicators.ma10[technicalIndicators.ma10.length - 2];
    
    let maCrossSignal = null;
    let maCrossText = '无交叉';
    
    // 检查金叉（MA5上穿MA10）
    if (ma5Previous.value <= ma10Previous.value && ma5Latest.value > ma10Latest.value) {
        maCrossSignal = 'golden-cross';
        maCrossText = '金叉📈';
        log(`检测到MA金叉信号: MA5(${ma5Latest.value.toFixed(2)}) > MA10(${ma10Latest.value.toFixed(2)})`, 'success');
        
        if (voiceEnabled) {
            speak('检测到金叉信号');
        }
    }
    // 检查死叉（MA5下穿MA10）
    else if (ma5Previous.value >= ma10Previous.value && ma5Latest.value < ma10Latest.value) {
        maCrossSignal = 'death-cross';
        maCrossText = '死叉📉';
        log(`检测到MA死叉信号: MA5(${ma5Latest.value.toFixed(2)}) < MA10(${ma10Latest.value.toFixed(2)})`, 'error');
        
        if (voiceEnabled) {
            speak('检测到死叉信号');
        }
    }
    
    technicalSignals.maCross = maCrossSignal;
    
    // 更新MA交叉信号显示
    const maCrossElement = document.getElementById('ma-cross-signal');
    maCrossElement.querySelector('.signal-value').textContent = maCrossText;
    
    if (maCrossSignal === 'golden-cross') {
        maCrossElement.className = 'signal-card signal-bullish';
    } else if (maCrossSignal === 'death-cross') {
        maCrossElement.className = 'signal-card signal-bearish';
    } else {
        maCrossElement.className = 'signal-card signal-neutral';
    }
    
    return maCrossSignal;
}

// ========== 进场条件评估 ==========
async function evaluateEntryConditions() {
    log('开始评估进场条件...');
    
    if (!isConnected) {
        log('错误: 数据未连接', 'error');
        return;
    }
    
    if (klineData.length < 50) {
        log('错误: 数据不足，请等待更多数据', 'error');
        return;
    }
    
    entryConditions.score = 0;
    entryConditions.conditions = [];
    entryConditions.shouldEnter = false;
    
    let totalScore = 0;
    let maxScore = 100;
    
    try {
        // 1. 订单簿分析 (30分)
        const orderbookScore = await evaluateOrderbook();
        totalScore += orderbookScore;
        
        // 2. 技术指标分析 (40分)
        const technicalScore = evaluateTechnicalIndicators();
        totalScore += technicalScore;
        
        // 3. MA交叉信号 (20分)
        const maCrossScore = evaluateMACross();
        totalScore += maCrossScore;
        
        // 4. 支撑压力分析 (10分)
        const supportResistanceScore = evaluateSupportResistance();
        totalScore += supportResistanceScore;
        
        // 计算最终评分
        entryConditions.score = totalScore / maxScore;
        entryConditions.shouldEnter = entryConditions.score >= 0.6;
        
        // 更新显示
        updateEntryConditionsDisplay();
        
        log(`进场条件评估完成: 评分 ${(entryConditions.score * 100).toFixed(1)}% - ${entryConditions.shouldEnter ? '✓ 建议进场' : '✗ 不建议进场'}`);
        
        // 检查是否满足自动预测条件
        checkAutoPredictionConditions();
        
        // 语音提示
        if (voiceEnabled) {
            if (entryConditions.shouldEnter) {
                speak(`进场条件评估通过，评分${Math.round(entryConditions.score * 100)}%`);
            }
        }
        
        return entryConditions;
        
    } catch (error) {
        log(`评估进场条件失败: ${error}`, 'error');
        return null;
    }
}

async function evaluateOrderbook() {
    let score = 0;
    
    try {
        // 获取订单簿数据
        const response = await fetch('https://api.binance.com/api/v3/depth?symbol=BTCUSDT&limit=50');
        if (!response.ok) throw new Error('获取订单簿失败');
        
        const data = await response.json();
        const bids = data.bids.slice(0, 10).map(b => ({ price: parseFloat(b[0]), quantity: parseFloat(b[1]) }));
        const asks = data.asks.slice(0, 10).map(a => ({ price: parseFloat(a[0]), quantity: parseFloat(a[1]) }));
        
        // 计算买盘集中度
        const totalBidVolume = bids.reduce((sum, b) => sum + b.quantity, 0);
        const topBidVolume = bids.slice(0, 5).reduce((sum, b) => sum + b.quantity, 0);
        const bidConcentration = totalBidVolume > 0 ? topBidVolume / totalBidVolume : 0;
        
        // 计算卖盘集中度
        const totalAskVolume = asks.reduce((sum, a) => sum + a.quantity, 0);
        const topAskVolume = asks.slice(0, 5).reduce((sum, a) => sum + a.quantity, 0);
        const askConcentration = totalAskVolume > 0 ? topAskVolume / totalAskVolume : 0;
        
        // 买卖压力比
        const pressureRatio = topBidVolume / (topAskVolume + 0.0001);
        
        // 评估条件
        if (bidConcentration > 0.75) {
            score += 15;
            entryConditions.conditions.push({
                text: `买盘集中度高 ✓ (${(bidConcentration * 100).toFixed(1)}%)`,
                pass: true
            });
        } else {
            entryConditions.conditions.push({
                text: `买盘集中度不足 (${(bidConcentration * 100).toFixed(1)}%)`,
                pass: false
            });
        }
        
        if (pressureRatio > 1.5) {
            score += 15;
            entryConditions.conditions.push({
                text: `买压强劲 ✓ (${pressureRatio.toFixed(2)}x)`,
                pass: true
            });
        } else {
            entryConditions.conditions.push({
                text: `买压不足 (${pressureRatio.toFixed(2)}x)`,
                pass: false
            });
        }
        
        // 更新订单簿信号显示
        const orderbookSignal = document.getElementById('orderbook-signal');
        if (pressureRatio > 1.5) {
            orderbookSignal.className = 'signal-card signal-bullish';
            orderbookSignal.querySelector('.signal-value').textContent = '买压强劲';
        } else if (pressureRatio < 0.67) {
            orderbookSignal.className = 'signal-card signal-bearish';
            orderbookSignal.querySelector('.signal-value').textContent = '卖压强劲';
        } else {
            orderbookSignal.className = 'signal-card signal-neutral';
            orderbookSignal.querySelector('.signal-value').textContent = '平衡';
        }
        
    } catch (error) {
        log(`订单簿分析失败: ${error}`, 'error');
        entryConditions.conditions.push({
            text: `订单簿分析错误: ${error.message}`,
            pass: false
        });
    }
    
    return score;
}

function evaluateTechnicalIndicators() {
    let score = 0;
    
    try {
        if (klineData.length < 20) {
            entryConditions.conditions.push({
                text: '数据不足，无法进行技术分析',
                pass: false
            });
            return score;
        }
        
        const latest = klineData[klineData.length - 1];
        
        // 计算RSI
        if (klineData.length >= 14) {
            const rsi = calculateRSI(14);
            if (rsi < 30) {
                score += 20;
                entryConditions.conditions.push({
                    text: `RSI超卖 ✓ (${rsi.toFixed(1)})`,
                    pass: true
                });
                technicalSignals.rsiSignal = 'oversold';
            } else if (rsi > 70) {
                entryConditions.conditions.push({
                    text: `RSI超买 (${rsi.toFixed(1)})`,
                    pass: false
                });
                technicalSignals.rsiSignal = 'overbought';
            } else {
                score += 10;
                entryConditions.conditions.push({
                    text: `RSI正常 (${rsi.toFixed(1)})`,
                    pass: true
                });
                technicalSignals.rsiSignal = null;
            }
        }
        
        // MA排列分析
        if (technicalIndicators.ma5.length > 0 && technicalIndicators.ma10.length > 0) {
            const ma5 = technicalIndicators.ma5[technicalIndicators.ma5.length - 1].value;
            const ma10 = technicalIndicators.ma10[technicalIndicators.ma10.length - 1].value;
            
            if (ma5 > ma10) {
                score += 10;
                entryConditions.conditions.push({
                    text: 'MA5在MA10之上 ✓',
                    pass: true
                });
            } else {
                entryConditions.conditions.push({
                    text: 'MA5在MA10之下',
                    pass: false
                });
            }
            
            if (latest.close > ma5) {
                score += 10;
                entryConditions.conditions.push({
                    text: '价格在MA5之上 ✓',
                    pass: true
                });
            } else {
                entryConditions.conditions.push({
                    text: '价格在MA5之下',
                    pass: false
                });
            }
        }
        
        // 更新技术信号显示
        const technicalSignal = document.getElementById('technical-signal');
        if (score >= 25) {
            technicalSignal.className = 'signal-card signal-bullish';
            technicalSignal.querySelector('.signal-value').textContent = '看涨';
        } else if (score <= 10) {
            technicalSignal.className = 'signal-card signal-bearish';
            technicalSignal.querySelector('.signal-value').textContent = '看跌';
        } else {
            technicalSignal.className = 'signal-card signal-neutral';
            technicalSignal.querySelector('.signal-value').textContent = '中性';
        }
        
    } catch (error) {
        log(`技术指标分析失败: ${error}`, 'error');
        entryConditions.conditions.push({
            text: `技术分析错误: ${error.message}`,
            pass: false
        });
    }
    
    return score;
}

function calculateRSI(period = 14) {
    if (klineData.length < period + 1) return 50;
    
    let gains = 0;
    let losses = 0;
    
    for (let i = klineData.length - period; i < klineData.length; i++) {
        const change = klineData[i].close - klineData[i-1].close;
        if (change > 0) {
            gains += change;
        } else {
            losses -= change;
        }
    }
    
    const avgGain = gains / period;
    const avgLoss = losses / period;
    
    if (avgLoss === 0) return 100;
    
    const rs = avgGain / avgLoss;
    return 100 - (100 / (1 + rs));
}

function evaluateMACross() {
    let score = 0;
    
    const maCrossSignal = technicalSignals.maCross;
    
    if (maCrossSignal === 'golden-cross') {
        score += 20;
        entryConditions.conditions.push({
            text: 'MA金叉信号 ✓',
            pass: true
        });
    } else if (maCrossSignal === 'death-cross') {
        score += 10; // 死叉也可作为信号，但分数较低
        entryConditions.conditions.push({
            text: 'MA死叉信号',
            pass: false
        });
    } else {
        entryConditions.conditions.push({
            text: '无MA交叉信号',
            pass: false
        });
    }
    
    return score;
}

function evaluateSupportResistance() {
    let score = 0;
    
    const supportResistanceSignal = technicalSignals.supportResistance;
    
    if (supportResistanceSignal === 'strong-support') {
        score += 10;
        entryConditions.conditions.push({
            text: '强支撑位附近 ✓',
            pass: true
        });
    } else if (supportResistanceSignal === 'support') {
        score += 5;
        entryConditions.conditions.push({
            text: '接近支撑位',
            pass: true
        });
    } else if (supportResistanceSignal === 'strong-resistance') {
        entryConditions.conditions.push({
            text: '强压力位附近',
            pass: false
        });
    } else if (supportResistanceSignal === 'resistance') {
        entryConditions.conditions.push({
            text: '接近压力位',
            pass: false
        });
    } else {
        entryConditions.conditions.push({
            text: '支撑压力位中性',
            pass: true
        });
        score += 3;
    }
    
    return score;
}

function updateEntryConditionsDisplay() {
    const container = document.getElementById('entry-conditions');
    container.innerHTML = '';
    
    // 更新评分显示
    const scorePercent = Math.round(entryConditions.score * 100);
    document.getElementById('score-text').textContent = `${scorePercent}%`;
    document.getElementById('score-fill').style.width = `${scorePercent}%`;
    
    // 设置评分颜色
    const scoreFill = document.getElementById('score-fill');
    if (scorePercent >= 60) {
        scoreFill.style.background = '#00c853';
    } else if (scorePercent >= 40) {
        scoreFill.style.background = '#f7931a';
    } else {
        scoreFill.style.background = '#ff3d00';
    }
    
    // 显示条件列表
    entryConditions.conditions.forEach(condition => {
        const div = document.createElement('div');
        div.className = `condition-item ${condition.pass ? 'pass' : 'fail'}`;
        
        const icon = document.createElement('i');
        icon.className = condition.pass ? 'fas fa-check-circle' : 'fas fa-times-circle';
        
        div.appendChild(icon);
        div.appendChild(document.createTextNode(` ${condition.text}`));
        
        container.appendChild(div);
    });
    
    // 添加总结
    const summary = document.createElement('div');
    summary.className = `condition-item ${entryConditions.shouldEnter ? 'pass' : 'fail'}`;
    
    const summaryIcon = document.createElement('i');
    summaryIcon.className = entryConditions.shouldEnter ? 'fas fa-thumbs-up' : 'fas fa-thumbs-down';
    
    summary.appendChild(summaryIcon);
    summary.appendChild(document.createTextNode(` ${entryConditions.shouldEnter ? '建议进场' : '不建议进场'}`));
    
    container.appendChild(summary);
}

// ========== 自动预测系统 ==========
function startAutoEvaluation() {
    // 清除现有定时器
    if (autoEvaluationInterval) {
        clearInterval(autoEvaluationInterval);
    }
    
    // 每30秒自动评估一次
    autoEvaluationInterval = setInterval(() => {
        if (isConnected && !isPredicting) {
            evaluateEntryConditions();
        }
    }, 30000); // 30秒
    
    log('自动评估已启动 (每30秒一次)');
    updateAutoPredictionStatus();
}

function stopAutoEvaluation() {
    if (autoEvaluationInterval) {
        clearInterval(autoEvaluationInterval);
        autoEvaluationInterval = null;
    }
    
    log('自动评估已停止');
    updateAutoPredictionStatus();
}

function toggleAutoPrediction() {
    const autoPredictToggle = document.getElementById('auto-predict-toggle');
    
    if (autoPredictToggle.checked) {
        if (isConnected) {
            startAutoEvaluation();
            log('自动预测模式已开启');
            speak('自动预测模式已开启');
        } else {
            autoPredictToggle.checked = false;
            alert('请先连接数据源');
        }
    } else {
        stopAutoEvaluation();
        log('自动预测模式已关闭');
    }
    
    updateAutoPredictionStatus();
}

function checkAutoPredictionConditions() {
    const autoPredictToggle = document.getElementById('auto-predict-toggle');
    
    // 检查自动预测是否启用
    if (!autoPredictToggle.checked) {
        return;
    }
    
    // 检查是否已经在预测中
    if (isPredicting) {
        return;
    }
    
    // 检查冷却时间
    const now = Date.now();
    if (now - lastAutoPredictionTime < autoPredictionCooldown) {
        const remainingMinutes = Math.ceil((autoPredictionCooldown - (now - lastAutoPredictionTime)) / 60000);
        log(`自动预测冷却中，还需等待 ${remainingMinutes} 分钟`, 'warning');
        return;
    }
    
    // 检查进场条件
    if (entryConditions.score >= 0.6 && entryConditions.shouldEnter) {
        // 检查是否有强烈的技术信号
        const hasStrongSignal = technicalSignals.maCross === 'golden-cross' || 
                               technicalSignals.maCross === 'death-cross' ||
                               technicalSignals.supportResistance === 'strong-support' ||
                               technicalSignals.supportResistance === 'strong-resistance';
        
        if (hasStrongSignal) {
            log('满足自动预测条件，开始自动预测...', 'success');
            
            // 根据信号确定预测方向
            let predictionDirection = null;
            
            if (technicalSignals.maCross === 'golden-cross' || technicalSignals.supportResistance === 'strong-support') {
                predictionDirection = 1; // 看涨
            } else if (technicalSignals.maCross === 'death-cross' || technicalSignals.supportResistance === 'strong-resistance') {
                predictionDirection = 0; // 看跌
            } else {
                // 默认随机方向
                predictionDirection = Math.random() > 0.5 ? 1 : 0;
            }
            
            // 执行自动预测
            executeAutoPrediction(predictionDirection);
        }
    }
}

function executeAutoPrediction(predictionDirection) {
    if (isPredicting) {
        return;
    }
    
    isPredicting = true;
    startPrice = currentPrice;
    predictionStartTime = new Date();
    
    const confidence = 0.6 + Math.random() * 0.3; // 60-90%置信度
    
    currentPrediction = {
        direction: predictionDirection,
        confidence: confidence,
        startPrice: startPrice,
        startTime: predictionStartTime,
        isAuto: true
    };
    
    // 更新显示
    document.getElementById('start-price').textContent = `$${startPrice.toFixed(2)}`;
    document.getElementById('prediction-direction').textContent = predictionDirection === 1 ? '上涨 📈' : '下跌 📉';
    document.getElementById('prediction-direction').className = `prediction-value ${predictionDirection === 1 ? 'up' : 'down'}`;
    document.getElementById('prediction-confidence').textContent = `置信度: ${(confidence * 100).toFixed(1)}%`;
    
    document.getElementById('start-prediction-btn').disabled = true;
    document.getElementById('stop-prediction-btn').disabled = false;
    document.getElementById('connect-btn').disabled = true;
    
    // 记录自动预测时间
    lastAutoPredictionTime = Date.now();
    
    // 语音播报
    if (voiceEnabled) {
        speak(`自动预测开始，预测${predictionDirection === 1 ? '上涨' : '下跌'}，开始价格${startPrice.toFixed(0)}美元`);
    }
    
    log(`自动预测开始: ${predictionDirection === 1 ? '看涨' : '看跌'} (置信度: ${(confidence * 100).toFixed(1)}%)`, 'success');
    log(`开始价格: $${startPrice.toFixed(2)}`);
    log(`触发信号: ${technicalSignals.maCross || technicalSignals.supportResistance || '综合评分'}`);
    
    startCountdown();
}

function updateAutoPredictionStatus() {
    const autoPredictToggle = document.getElementById('auto-predict-toggle');
    const dot = document.getElementById('auto-status-dot');
    const statusText = document.getElementById('auto-status-text');
    const nextTime = document.getElementById('auto-next-time');
    
    if (autoPredictToggle.checked && isConnected) {
        dot.className = 'auto-status-dot active';
        statusText.textContent = '自动评估: 开启';
        statusText.style.color = '#00c853';
        
        // 计算下次评估时间
        if (autoEvaluationInterval) {
            const now = new Date();
            const next = new Date(now.getTime() + 30000); // 30秒后
            nextTime.textContent = `下次: ${next.getMinutes()}:${next.getSeconds().toString().padStart(2, '0')}`;
        }
    } else {
        dot.className = 'auto-status-dot';
        statusText.textContent = '自动评估: 关闭';
        statusText.style.color = '#8a9ba8';
        nextTime.textContent = '--';
    }
}

// ========== 预测系统 ==========
function startPrediction() {
    if (!isConnected) {
        alert('请先连接数据源');
        log('错误: 数据未连接，无法开始预测', 'error');
        return;
    }
    
    if (isPredicting) {
        alert('预测已在运行中');
        return;
    }
    
    // 自动评估进场条件
    const autoEvaluate = document.getElementById('auto-evaluate-toggle').checked;
    
    if (autoEvaluate) {
        evaluateEntryConditions().then(conditions => {
            if (conditions && conditions.shouldEnter) {
                confirmAndStartPrediction();
            } else {
                alert('进场条件不满足，建议等待更好时机');
                log('预测取消: 进场条件不满足');
                
                if (voiceEnabled) {
                    speak('进场条件不满足，预测取消');
                }
            }
        });
    } else {
        confirmAndStartPrediction();
    }
}

function confirmAndStartPrediction() {
    const confirmed = confirm(
        '即将开始5分钟预测周期。\n\n' +
        '预测流程:\n' +
        '1. 记录开始价格\n' +
        '2. 进行方向预测\n' +
        '3. 5分钟倒计时\n' +
        '4. 验证预测结果\n' +
        '5. 更新胜率统计\n\n' +
        '是否继续?'
    );
    
    if (!confirmed) {
        log('预测取消: 用户取消');
        return;
    }
    
    isPredicting = true;
    startPrice = currentPrice;
    predictionStartTime = new Date();
    
    // 生成随机预测（实际应用应使用模型）
    const prediction = Math.random() > 0.5 ? 1 : 0; // 1: 上涨, 0: 下跌
    const confidence = 0.5 + Math.random() * 0.3; // 50-80%置信度
    
    currentPrediction = {
        direction: prediction,
        confidence: confidence,
        startPrice: startPrice,
        startTime: predictionStartTime,
        isAuto: false
    };
    
    // 更新显示
    document.getElementById('start-price').textContent = `$${startPrice.toFixed(2)}`;
    document.getElementById('prediction-direction').textContent = prediction === 1 ? '上涨 📈' : '下跌 📉';
    document.getElementById('prediction-direction').className = `prediction-value ${prediction === 1 ? 'up' : 'down'}`;
    document.getElementById('prediction-confidence').textContent = `置信度: ${(confidence * 100).toFixed(1)}%`;
    
    document.getElementById('start-prediction-btn').disabled = true;
    document.getElementById('stop-prediction-btn').disabled = false;
    document.getElementById('connect-btn').disabled = true;
    
    // 语音播报
    if (voiceEnabled) {
        speak(`预测开始，预测${prediction === 1 ? '上涨' : '下跌'}，开始价格${startPrice.toFixed(0)}美元`);
    }
    
    log(`开始预测: ${prediction === 1 ? '看涨' : '看跌'} (置信度: ${(confidence * 100).toFixed(1)}%)`, 'success');
    log(`开始价格: $${startPrice.toFixed(2)}`);
    
    startCountdown();
}

function stopPrediction() {
    if (!isPredicting) return;
    
    isPredicting = false;
    
    document.getElementById('start-prediction-btn').disabled = false;
    document.getElementById('stop-prediction-btn').disabled = true;
    document.getElementById('connect-btn').disabled = false;
    
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    
    // 重置倒计时
    countdownSeconds = 300;
    updateCountdownDisplay();
    
    log('预测已停止');
    
    if (voiceEnabled) {
        speak('预测已停止');
    }
    
    // 5分钟后验证结果（如果预测已经开始）
    if (currentPrediction && startPrice > 0) {
        setTimeout(() => {
            verifyPredictionResult();
        }, 300000);
    }
}

function startCountdown() {
    countdownSeconds = 300;
    
    countdownInterval = setInterval(() => {
        countdownSeconds--;
        
        updateCountdownDisplay();
        
        // 更新当前结果
        if (countdownSeconds % 30 === 0) {
            updateCurrentResult();
        }
        
        if (countdownSeconds <= 0) {
            clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = '00:00';
            
            log('5分钟预测周期结束，正在验证结果...');
            stopPrediction();
            
            // 立即验证结果
            verifyPredictionResult();
        }
    }, 1000);
}

function updateCountdownDisplay() {
    const minutes = Math.floor(countdownSeconds / 60);
    const seconds = countdownSeconds % 60;
    
    document.getElementById('countdown').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // 颜色变化
    const countdownElement = document.getElementById('countdown');
    if (countdownSeconds > 60) {
        countdownElement.style.color = '#2196F3';
    } else if (countdownSeconds > 10) {
        countdownElement.style.color = '#FF9800';
    } else {
        countdownElement.style.color = '#F44336';
    }
}

function updateCurrentResult() {
    if (!isPredicting || startPrice === 0) return;
    
    const change = ((currentPrice - startPrice) / startPrice * 100);
    const predictedUp = currentPrediction.direction === 1;
    const actualUp = currentPrice > startPrice;
    
    document.getElementById('current-result').textContent = 
        predictedUp === actualUp ? '预测正确 ✓' : '预测错误 ✗';
    document.getElementById('current-result').className = `prediction-value ${predictedUp === actualUp ? 'up' : 'down'}`;
    document.getElementById('result-change').textContent = `变化: ${change.toFixed(2)}%`;
}

async function verifyPredictionResult() {
    if (!currentPrediction || startPrice === 0) return;
    
    try {
        // 获取当前价格
        const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
        if (!response.ok) throw new Error('获取验证价格失败');
        
        const data = await response.json();
        const endPrice = parseFloat(data.price);
        
        // 计算实际结果
        const predictedUp = currentPrediction.direction === 1;
        const actualUp = endPrice > startPrice;
        const isCorrect = predictedUp === actualUp;
        const changePercent = ((endPrice - startPrice) / startPrice * 100).toFixed(2);
        
        // 更新胜率统计
        winRateTracker.addTrade(isCorrect);
        
        // 显示结果
        log('════════════════════════════════════════');
        log(`预测结果: ${isCorrect ? '✅ 正确' : '❌ 错误'}`, isCorrect ? 'success' : 'error');
        log(`开始价格: $${startPrice.toFixed(2)}`);
        log(`结束价格: $${endPrice.toFixed(2)}`);
        log(`价格变化: ${changePercent}%`);
        log(`预测方向: ${predictedUp ? '上涨' : '下跌'}`);
        log(`实际方向: ${actualUp ? '上涨' : '下跌'}`);
        log(`置信度: ${(currentPrediction.confidence * 100).toFixed(1)}%`);
        log(`进场评分: ${Math.round(entryConditions.score * 100)}%`);
        log(`预测类型: ${currentPrediction.isAuto ? '自动预测' : '手动预测'}`);
        log('════════════════════════════════════════');
        
        // 语音播报
        if (voiceEnabled) {
            if (isCorrect) {
                speak(`预测正确，价格变化${Math.abs(changePercent)}%`);
            } else {
                speak(`预测错误，价格变化${Math.abs(changePercent)}%`);
            }
        }
        
        // 重置预测状态
        currentPrediction = null;
        startPrice = 0;
        
        // 更新当前结果显示
        document.getElementById('current-result').textContent = isCorrect ? '正确 ✓' : '错误 ✗';
        document.getElementById('current-result').className = `prediction-value ${isCorrect ? 'up' : 'down'}`;
        document.getElementById('result-change').textContent = `变化: ${changePercent}%`;
        
    } catch (error) {
        log(`验证预测结果失败: ${error}`, 'error');
    }
}

// ========== 页面加载 ==========
document.addEventListener('DOMContentLoaded', () => {
    log('BTC智能预测系统启动中...');
    initSystem();
});

// ========== 显示更新 ==========
function updateChart() {
    if (klineData.length === 0 || !candleSeries) return;
    
    try {
        const candleData = klineData.map(dp => ({
            time: dp.time,
            open: dp.open,
            high: dp.high,
            low: dp.low,
            close: dp.close,
        }));
        
        candleSeries.setData(candleData);
        chart.timeScale().fitContent();
    } catch (error) {
        log(`更新图表失败: ${error}`, 'error');
    }
}

function updateMALines() {
    const ma5Enabled = document.getElementById('ma5-toggle').checked;
    const ma10Enabled = document.getElementById('ma10-toggle').checked;
    const ma20Enabled = document.getElementById('ma20-toggle').checked;
    const ma60Enabled = document.getElementById('ma60-toggle').checked;
    
    if (ma5Enabled && technicalIndicators.ma5.length > 0) {
        ma5Series.setData(technicalIndicators.ma5);
    } else {
        ma5Series.setData([]);
    }
    
    if (ma10Enabled && technicalIndicators.ma10.length > 0) {
        ma10Series.setData(technicalIndicators.ma10);
    } else {
        ma10Series.setData([]);
    }
    
    if (ma20Enabled && technicalIndicators.ma20.length > 0) {
        ma20Series.setData(technicalIndicators.ma20);
    } else {
        ma20Series.setData([]);
    }
    
    if (ma60Enabled && technicalIndicators.ma60.length > 0) {
        ma60Series.setData(technicalIndicators.ma60);
    } else {
        ma60Series.setData([]);
    }
}

function updateDepthDisplay() {
    if (!depthChart || depthData.bids.length === 0 || depthData.asks.length === 0) return;
    
    const bidPrices = depthData.bids.map(b => b.price);
    const bidQuantities = depthData.bids.map(b => b.quantity);
    const askPrices = depthData.asks.map(a => a.price);
    const askQuantities = depthData.asks.map(a => a.quantity);
    
    let bidCumulative = 0;
    const bidCumulativeData = [];
    for (let i = 0; i < bidPrices.length; i++) {
        bidCumulative += bidQuantities[i];
        bidCumulativeData.push(bidCumulative);
    }
    
    let askCumulative = 0;
    const askCumulativeData = [];
    for (let i = 0; i < askPrices.length; i++) {
        askCumulative += askQuantities[i];
        askCumulativeData.push(askCumulative);
    }
    
    const allPrices = [...bidPrices, ...askPrices].sort((a, b) => a - b);
    
    depthChart.data.labels = allPrices;
    depthChart.data.datasets[0].data = allPrices.map(price => {
        const bidIndex = bidPrices.findIndex(p => p === price);
        return bidIndex >= 0 ? bidCumulativeData[bidIndex] : 0;
    });
    depthChart.data.datasets[1].data = allPrices.map(price => {
        const askIndex = askPrices.findIndex(p => p === price);
        return askIndex >= 0 ? askCumulativeData[askIndex] : 0;
    });
    
    depthChart.update();
    
    const totalBid = bidCumulative;
    const totalAsk = askCumulative;
    const ratio = totalBid > 0 ? (totalAsk / totalBid).toFixed(2) : '--';
    
    document.getElementById('total-bid').textContent = totalBid.toFixed(2);
    document.getElementById('total-ask').textContent = totalAsk.toFixed(2);
    document.getElementById('bid-ask-ratio').textContent = ratio;
    
    if (depthData.bids.length > 0 && depthData.asks.length > 0) {
        const bestBid = depthData.bids[0];
        const bestAsk = depthData.asks[0];
        
        document.getElementById('depth-best-bid').textContent = `买: ${bestBid.price.toFixed(2)}`;
        document.getElementById('depth-best-ask').textContent = `卖: ${bestAsk.price.toFixed(2)}`;
        
        const spread = bestAsk.price - bestBid.price;
        const spreadPercent = (spread / bestBid.price * 100).toFixed(2);
        document.getElementById('depth-spread').textContent = `价差: ${spread.toFixed(2)} (${spreadPercent}%)`;
    }
}

function updatePriceDisplay(price) {
    const priceElement = document.getElementById('current-price');
    const previousText = priceElement.textContent;
    const previousPrice = previousText === '$--' ? price : parseFloat(previousText.replace(/[^0-9.-]+/g, ''));
    
    priceElement.textContent = `$${price.toFixed(2)}`;
    
    if (price > previousPrice) {
        priceElement.className = 'price-display price-up';
    } else if (price < previousPrice) {
        priceElement.className = 'price-display price-down';
    } else {
        priceElement.className = 'price-display';
    }
    
    const priceStatus = document.getElementById('price-status');
    priceStatus.className = 'status-indicator connected';
}

function changeInterval(interval) {
    if (currentInterval === interval) return;
    
    currentInterval = interval;
    
    document.querySelectorAll('.interval-btn').forEach(btn => {
        if (btn.dataset.interval === interval) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    log(`切换时间周期为: ${interval}`);
    
    if (isConnected) {
        disconnectWebSocket();
        setTimeout(() => {
            connectWebSocket();
        }, 500);
    }
}

function toggleVoice() {
    voiceEnabled = !voiceEnabled;
    
    if (voiceEnabled) {
        if (!speechSynthesis) {
            alert('您的浏览器不支持语音合成功能');
            voiceEnabled = false;
            return;
        }
        
        document.getElementById('toggle-voice-btn').innerHTML = 
            '<i class="fas fa-volume-up"></i> 关闭语音';
        document.getElementById('voice-status-text').textContent = '语音开启';
        document.getElementById('voice-indicator').className = 'status-indicator connected';
        
        speak('语音提示已开启');
        log('语音提示已开启');
    } else {
        document.getElementById('toggle-voice-btn').innerHTML = 
            '<i class="fas fa-volume-mute"></i> 开启语音';
        document.getElementById('voice-status-text').textContent = '语音关闭';
        document.getElementById('voice-indicator').className = 'status-indicator disconnected';
        
        log('语音提示已关闭');
    }
}

function speak(text) {
    if (!voiceEnabled || !speechSynthesis) return;
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-CN';
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    speechSynthesis.speak(utterance);
}

function updateConnectionStatus(connected) {
    isConnected = connected;
    
    const connectBtn = document.getElementById('connect-btn');
    const disconnectBtn = document.getElementById('disconnect-btn');
    
    if (connected) {
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        document.getElementById('price-status').className = 'status-indicator connected';
        
        // 连接成功后更新自动预测状态
        updateAutoPredictionStatus();
    } else {
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        document.getElementById('price-status').className = 'status-indicator disconnected';
        
        // 断开连接后停止自动评估
        stopAutoEvaluation();
    }
}

function updateVoiceStatus() {
    const indicator = document.getElementById('voice-indicator');
    const statusText = document.getElementById('voice-status-text');
    const toggleBtn = document.getElementById('toggle-voice-btn');
    
    if (voiceEnabled) {
        indicator.className = 'status-indicator connected';
        statusText.textContent = '语音开启';
        toggleBtn.innerHTML = '<i class="fas fa-volume-up"></i> 关闭语音';
    } else {
        indicator.className = 'status-indicator disconnected';
        statusText.textContent = '语音关闭';
        toggleBtn.innerHTML = '<i class="fas fa-volume-mute"></i> 开启语音';
    }
}

function updateStatus(status) {
    log(`系统状态: ${status}`);
}

function log(message, type = 'info') {
    const logContainer = document.getElementById('log-container');
    const now = new Date();
    const timeStr = now.toTimeString().split(' ')[0];
    
    const logEntry = document.createElement('div');
    logEntry.className = 'log-entry';
    
    let color = '#8a9ba8';
    if (type === 'success') color = '#00c853';
    if (type === 'error') color = '#ff3d00';
    if (type === 'warning') color = '#f7931a';
    
    logEntry.innerHTML = `<span class="log-time" style="color:${color}">[${timeStr}]</span> ${message}`;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
    
    const entries = logContainer.getElementsByClassName('log-entry');
    if (entries.length > 100) {
        logContainer.removeChild(entries[0]);
    }
}

function generateDemoData() {
    log('生成演示数据...');
    
    const basePrice = 45000;
    klineData = [];
    
    let price = basePrice;
    for (let i = 0; i < 200; i++) {
        const time = Math.floor(Date.now() / 1000) - (200 - i) * 60;
        
        const trend = Math.sin(i / 20) * 1000;
        const noise = (Math.random() - 0.5) * 500;
        
        price = price + trend / 200 + noise;
        
        const open = price;
        const close = price + (Math.random() - 0.5) * 300;
        const high = Math.max(open, close) + Math.random() * 200;
        const low = Math.min(open, close) - Math.random() * 200;
        
        klineData.push({
            time,
            open,
            high,
            low,
            close,
            volume: 100 + Math.random() * 50
        });
    }
    
    currentPrice = klineData[klineData.length - 1].close;
    updateChart();
    calculateMAs();
    calculateSupportResistance();
    updatePriceDisplay(currentPrice);
    
    log('演示数据生成完成');
}

function generateDemoDepthData() {
    log('生成演示深度数据...');
    
    const basePrice = currentPrice || 45000;
    depthData.bids = [];
    depthData.asks = [];
    
    let bidPrice = basePrice * 0.98;
    for (let i = 0; i < 20; i++) {
        depthData.bids.push({
            price: bidPrice,
            quantity: 0.5 + Math.random() * 2
        });
        bidPrice += basePrice * 0.001;
    }
    
    let askPrice = basePrice * 1.02;
    for (let i = 0; i < 20; i++) {
        depthData.asks.push({
            price: askPrice,
            quantity: 0.5 + Math.random() * 2
        });
        askPrice -= basePrice * 0.001;
    }
    
    depthData.bids.sort((a, b) => b.price - a.price);
    depthData.asks.sort((a, b) => a.price - b.price);
    
    updateDepthDisplay();
    log('演示深度数据生成完成');
}
</script>
</body>

</html>
